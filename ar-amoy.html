<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Archiary Interface</title>
  <!--<script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>-->
  <!--<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>-->
  <script src="ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <style>
  body {
    font-family: sans-serif;
    max-width: 800px;
    margin: auto;
    padding: 1em;
    background-color: #1e1e1e;
    color: #f0f0f0;
  }

  h1, h2 {
    color: #00b4d8;
  }

  h1 {
    text-align: center;
  }
  h5 {
    text-align: center; color: grey;
  }

  .header-container {
    display: flex;
    align-items: center;
    gap: 1.5em;
    margin-bottom: 1em;
    width: 100%;          /* p≈ôid√°no - zabere celou ≈°√≠≈ôku */
    justify-content: space-between;  /* prvky se rozt√°hnou od kraje ke kraji */
    box-sizing: border-box; /* aby padding/margin neovliv≈àovalo celkovou ≈°√≠≈ôku */
    padding: 0 1em;       /* mal√Ω odsazen√≠ zleva a zprava (lze upravit) */
  }
  .styled-button {
    width: auto;
    min-width: 110px;
    padding: 0.6em 1.2em;
    display: block;
    margin: 1em auto 0;
    background-color: #005a8c;
    color: lightgrey;
    border-radius: 5px;
    border: 1px solid #000000;
    cursor: pointer;
    transition: background-color 0.3s ease;
    max-height: 400px
  }
.styled-button:hover {
  background-color: #00416b; /* tmav≈°√≠ varianta modr√© */
}
 

  .logo {
    max-width: 100px;
    height: auto;
    object-fit: contain;
  }

  .highlight {
    font-size: 3em;
    font-weight: bold;
    color: #90e0ef;
    animation: fadeIn 0.5s ease-in-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes flash {
    0%   { background-color: #2ecc71; }
    100% { background-color: transparent; }
  }

  .flash {
    animation: flash 1s ease-out;
  }

  #balance {
    font-size: 1.50em;
    color: #48cae4;
    word-break: break-word;
    overflow-wrap: break-word;
    white-space: normal;
    display: block;
    max-width: 100%;   /* d≈Øle≈æit√© */
  }

  .balance-wrapper {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    font-weight: normal;
    color: #90e0ef;
    font-size: 1.2em;
    min-width: 100px;
    line-height: 1.0;
    word-wrap: break-word;
    overflow-wrap: break-word;
    white-space: normal;
  }

  .eth-label {
    color: #ccc;
    font-weight: normal;
    font-size: 0.8em;
    margin-top: 0.1em;
  }

  input {
    padding: 0.5em;
    font-size: 1em;
    width: 80%;
    margin: 0.5em auto;
    display: block;
    text-align: center;
    background-color: #333;
    color: #f0f0f0;
    border: 1px solid #555;
    border-radius: 5px;
  }

  button {
    width: auto;
    min-width: 120px;
    padding: 0.6em 1.2em;
    display: block;
    margin: 1em auto 0;
    background-color: #0077b6;
    color: white;
    border-radius: 5px;
    border: 2px solid #ccc;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  button:hover {
    background-color: #005f73;
  }

  button.fullwidth {
    width: 100%;
    margin: 1em 0 0;
  }

  #status {
    margin-top: 1em;
    font-weight: bold;
    text-align: left;
    max-width: 50%;
    width: 50%;
  }
  .nft-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 1em;
    margin-top: 0em;
    min-height: 100px;
  }

  .nft-card {
    border: 1px solid #444;
    border-radius: 5px;
    padding: 0.5em;
    background: #2a2a2a;
    width: 160px;
    text-align: center;
  }

  .nft-card img {
    width: 100%;
    height: 160px;
    object-fit: cover;
    border-radius: 5px;
  }
#contractAddress::selection {
  background-color: #666;
  color: #fff;
}
  #helpBox {
    display: none;
    background-color: #2a2a2a;
    border: 1px solid #444;
    border-radius: 8px;
    padding: 1em;
    margin-top: 1.5em;
    box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    font-size: 1em;
    line-height: 1.5;
    color: #ddd;
    width: 100%;
    box-sizing: border-box;
    overflow-x: auto;
    text-align: left;
  }

  @media (max-width: 600px) {
    body {
      background-color: #121212;
    }

    .header-container {
      flex-direction: column;
      align-items: center;
      gap: 0.5em;
      text-align: center;
    }

    .logo {
      width: 80px;
      height: 100px;
    }

    h1 {
      font-size: 1.5em;
    }

    

    .eth-label {
      font-size: 0.8em;
    }
  }
body.light-mode {
  background-color: #888888; /*#f5f5f5;*/
  color: #222;
}

body.light-mode h1, body.light-mode h2 {
  color: #0077b6;
}

body.light-mode .balance-wrapper {
  color: #0077b6;
}

body.light-mode input {
  background-color: #fff;
  color: #000;
  border: 1px solid #ccc;
}

body.light-mode .nft-card {
  background: #ffffff;
  border: 1px solid #ccc;
  color: #000;
}

body.light-mode #helpBox {
  background-color: #fff;
  color: #000;
  border-color: #ccc;
}

body.light-mode .eth-label {
  color: #555;
}

</style>

</head>
<body>

  <div class="header-container">
      <img src="logo_archiary.png" class="logo" alt="Archiary" />
    <h1>Get a record from the Archiary </h1>
    <div class="balance-wrapper">
      <div id="balance" class="highlight"></div>
      <div class="eth-label"></div>
    </div> 
  </div>

  <div style="text-align: center; margin-top: -1.5em;">
  <h5 style="margin: 0 0 0.2em 0;">Ethereum site Contract Archiary Address:</h5>
  <div style="display: inline-flex; align-items: center; gap: 0.2em; font-size: 1.3em; margin: 0;">
    <span id="contractAddress">Loading...</span>
    <button onclick="copyContractAddress()" 
            title="Copy to clipboard"
            style="
              padding: 0;
              margin-left: -2.1em;
              font-size: 0.9em;
              line-height: 1;
              cursor: pointer;
              border: none;
              background: none;
              vertical-align: middle;
              position: relative;
              top: -0.6em;
            ">
      üìã
    </button>
  </div>
</div>




  <h2>Select record from the list below üîç </h2>
  <div style="display: flex; gap: 1em;"> 
    <label for="record" style="margin-top: 0.9em; margin-right: -0.5em;">  üìñ Record:   </label>
    <input type="number" id="record" readonly placeholder="record" step="1" min="0"
      style="flex: 1; color: darkblue; background-color: #778899; border: 1px solid #ccc;
           padding: 0.2em; border-radius: 4px; font-size: 1.3em; font-weight: bold;" >
    <label for="record" style="margin-top: 0.9em; margin-right: -0.5em;">üü£ Eth:     </label>
    <input type="number" id="amount" readonly placeholder="amount in ETH"  step="0.00001" min="0.00001"
      style="flex: 1; color: darkblue; background-color: #778899; border: 1px solid #ccc;
           padding: 0.2em; border-radius: 4px; font-size: 1.3em; font-weight: bold;width-max:50px">       
  </div>
  <div id="statusZaznamu" style="display: flex;word-wrap: break-word; overflow-wrap: break-word;font-size: 1.50em;
    white-space: normal;font-weight: normal; color: white; text-align: left; margin: 1em auto;"></div>
    
  <button id="sendGetBtn" style="display:none;"onclick="sendGet()">‚è´ Send  a request and get  a record üì•</button>
  
  <div id="status2" style="word-wrap: break-word; overflow-wrap: break-word;
    white-space: normal;font-weight: normal; color: grey; text-align: center; margin: 1em auto;"></div>
  <div style="display: flex; justify-content: flex-start; align-items: center; gap: 1em; width: 90%; margin: 1em auto;">
        <div id="status" style="
    word-wrap: break-word;
    overflow-wrap: break-word;
    white-space: normal;font-weight: normal; color: lightgrey;
    ">Loading ...</div>
    <button id="indexBtn" class="styled-button" onclick="location.href='index.html';" >üè†Home </button>
    <button id="helpBtn" class="styled-button" onclick="toggleHelp()">‚ùìHelp</button>
    <button id="themeToggle" class="styled-button">üåû / üåô</button>
    <button id="reloadBtn" class="styled-button" onclick="reloadBtn()">üîÅReload</button>
  </div>
  
  <hr style="border: none; height: 2px; background-color: grey;">
  
  <div id="helpBox">Loading help...</div>
<!--------------- owner only-->

  <div id="ownerControls" style="display: none; justify-content: flex-start;width: 90%; margin: 0em 0;">
    <h2>üõ† Owner Controls </h2>
    <div style="display: flex; justify-content: flex-start; align-items: center; gap: 2px; 
            margin: -1em 0em 1em 5em;">
      <button onclick="withdrawAll()" 
        class="styled-button"style="margin: 0 0;">üè¶ Withdraw All</button>
      <button onclick="withdrawFees()" 
        class="styled-button"style="margin: 0 0;">üè¶ Withdraw Fees</button>  
      <button onclick="setContractActive(true)" 
        class="styled-button" style="margin: 0 0;">üîõ Activate</button>
      <button onclick="setContractActive(false)"
        class="styled-button" style="margin: 0 0;">üî¥ Deactivate</button>
    </div>
<!--
    <div style="display: flex; justify-content: flex-start; align-items: center; gap: 2px; 
          margin: 0em 0em 0em 3em;">
      <input type="number" id="clueIndex" placeholder="index (0-x)" min="0"
             style="width: 8em ;margin: 0em 1em 0em 0em;" />
      <button onclick="getClueInfo()"
        class="styled-button" style="margin: 0 0;">üîç Get Clue Info</button>
      <button onclick="getCluePriceInfo()"
        class="styled-button" style="margin: 0 0;">üí∞ Get Clue Price</button>
      <button onclick="getCluePriceInEthInfo()"
        class="styled-button" style="margin: 0 0;">üí∏ Get Clue Price in ETH</button>
    </div>

    <div style="display: flex; justify-content: flex-start; align-items: center; gap: 2px; 
          margin: 0em 0em 0em 3em;">
      <input type="number" id="jackpotVariant" placeholder="level (0-4)" min="0" max="4"
             style="width: 8em; margin: 0em 1em 0em 0em;" />
      <input type="number" id="userOrder" placeholder="user order (1-x)" min="1"
             style="width: 8em; margin: 0em 1em 0em 0em;" />       
      <button onclick="getJackpotWin()"
        class="styled-button" style="margin: 0 0;">üíº Get Win & Jackpot</button>
      <button onclick="getJackpotWinEth()"
        class="styled-button" style="margin: 0 0;">üí∏ Get Win & Jackpot in ETH</button>
    </div>
-->    
    <div style="display: flex; justify-content: flex-start; align-items: center; gap: 2px; 
          margin: 0em 0em 0em 3em;">
      <label for="deleteItem" style="margin-right: 0.5em;">Del Index:</label>    
      <input type="number" id="deleteItem" placeholder="clue DEL index" min="0" value="0"
             style="width: 8em; margin: 0em 1em 0em 0em;" />
      <button onclick="deleteItem()"
        class="styled-button" style="margin: 0 0;" >üí∏ DEL Clue by Index</button>
      <button onclick="deleteAll()"
        class="styled-button" style="margin: 0 0;" >‚ùå  DEL All Clues</button>  
      
    </div>
    <div style="display: flex; justify-content: flex-start; align-items: center; gap: 2px; 
          margin: 0em 0em 0em 3em;">
      <label for="clueCount" style="margin-right: 0.5em;">Start:</label>    
      <input type="number" id="clueStart" placeholder="clueStart (0-x)" min="0" value="0"
             style="width: 8em; margin: 0em 1em 0em 0em;" />
      <label for="clueCount" style="margin-right: 0.5em;">Count:</label>       
      <input type="number" id="clueCount" placeholder="clueCount (1-100)" min="1" value="100"
             style="width: 8em; margin: 0em 1em 0em 0em;" />       
      <button onclick="getCluesPage()"
        class="styled-button" style="margin: 0 0;">üíº Get Clue Page</button>
      
    </div>
    <div style="display: flex; justify-content: flex-start; align-items: center; gap: 2px; 
            margin: 1em 0em 1em 5em;">
      <button onclick="getAllPlayers()"
        class="styled-button" style="margin: 0 0;">üßë‚Äçü§ù‚Äçüßë Get All Players</button>
      <button onclick="getAllUsersData()"
        class="styled-button" style="margin: 0 0;">üìä Get All Users Data</button>
      <button onclick="getRebusData()"
        class="styled-button" style="margin: 0 0;">üß† Get Config</button>
      <button onclick="getUserDataOfAll()" 
        class="styled-button" style="margin: 0 0;">üìã Get User Data Of All</button>
    </div>
    <div id="ownerOutput" style="
      width: 100%;
      padding: 2em;
      background-color: #1a1a2e;
      color: #e0e0e0;
      border: 2px solid #00f5d4;
      border-radius: 12px;
      box-shadow: 0 0 10px #00f5d4;
      font-family: monospace;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: normal;
    "></div>

  </div>

  <div style="display: flex; align-items: center; gap: 10px;">
    <h2 style="margin: 0em;">Retrieved records üñºÔ∏è </h2>
      <div style="display: flex; justify-content: flex-end; align-items: center; gap: 4px;margin-left: auto;">
        <label for="recordsRetrieved">all:</label>    
        <input type="number" id="recordsRetrieved" placeholder="0" min="0" value="0" disabled
            style="width: 4em; height: 0.8em; padding: 6px; margin: 0;" />
        <label for="recordsShow">show:</label>    
        <input type="number" id="recordsShow" placeholder="0-10" min="1" value="10" onchange="loadNFTs()"
            style="width: 4em; height: 0.8em; padding: 6px; margin: 0;background: gray;" />
      </div>
  </div>

<!--  <div id="nftList" class="nft-grid">Loading...</div>  -->
  <div id="nftList" class="nft-grid" style="margin: 0.5em auto 0 auto; color: grey" >.</div>
<!--  
    <button id="burnRecordBtn"onclick="burnRecord()" 
        class="styled-button" style="margin: 0 0;">üìã Burn Record</button>
        
  <div id="statusNFT" style="word-wrap: break-word; overflow-wrap: break-word;
    white-space: normal;font-weight: normal; color: grey; text-align: center; margin: 1em auto;"></div>
 
<h2>üìñ List of available records</h2>
-->
  <div style="display: flex; align-items: center; gap: 10px;margin-top: 0.9em; ">
    <h2 style="margin: 0.0em;">List of available records üìñ </h2>
      <div style="display: flex; justify-content: flex-end; align-items: center; gap: 4px;margin-left: auto;">
        <label for="recordsAvailable">all:</label>    
        <input type="number" id="recordsAvailable" placeholder="0" min="0" value="0" disabled
            style="width: 4em; height: 0.8em; padding: 6px; margin: 0;" />
<!--    <label for="recordsAvailableShow">show:</label>    
        <input type="number" id="recordsAvailableShow" placeholder="0-10" min="1" value="100" onchange="odsReader()"
            style="width: 4em; height: 0.8em; padding: 6px; margin: 0;background: gray;" /> -->
      </div>
  </div>
  <div id="archiaryList"></div>

  
<!---------------message to owner c-->
  <h2>Write, comment... üí¨ </h2>
  
  <input type="text" id="fromInput"    data-default="Name or your@email" placeholder="Name or your@email" style="width: 70%;" />
  <input type="text" id="messageInput" data-default="Message"placeholder="Message" style="width: 70%;" />
  <!--<input type="text" id="addInput"     data-default="Additional info (URL or note)" placeholder="Additional info (URL or note)" />-->
  <input type="number" id="ethForMessage" data-default="ETH to send" placeholder="ETH to send" style="width: 50%;"/>
  <button onclick="sendMessageToOwner()">üìß Send Message</button>
  
  <div id="sendMessageToOwnerStatus" style="margin: 1em auto 0 auto;width: 90%; word-wrap: break-word; overflow-wrap: break-word; white-space: normal;text-align: center;"></div>
  



  <script>
    const CONTRACT_ADDRESS="0x618CED7896b0Ffb918306DbB4767a665C57416E2";
    
 /*   
    const ABI = [
  "function balanceOf(address owner) view returns (uint256)",
  "function tokenOfOwnerByIndex(address owner, uint256 index) view returns (uint256)",
  "function tokenURI(uint256 tokenId) view returns (string)",
  "function messageToOwner(string _from, string _message, string _add) external payable",
  "function withdrawAll() external",
  "function setActive(bool _state) external",
  "function owner() view returns (address)",
  "function getClue(uint index) external view returns (uint64, bytes, string, uint16, uint16, int64, uint16)",
  "function getCluePrice(uint index) external view returns (uint256, bytes, string, uint16, uint16, int64, uint16, uint256)",
  "function getCluePriceInEth(uint index) external view returns (string)",
  "function getcluewei(uint index) external view returns (uint256)",
  "function getminWinBalance(uint8 varianta) view returns (uint256)",
  "function getJackpot(uint8 varianta) view returns (uint256)",
  "function getJackpotWinBalance(uint8 varianta) view returns (uint256, uint256)",
  "function getJackpotWinBalanceInEth(uint8 varianta) view returns (string, string)",
  "function getAllPlayers() view returns (address[])",
  "function getRebusData() view returns (tuple(string name, uint256 attemptMinimum, bool active, uint8 prcJackpotOfBalance, uint256 multiplyToWei, string imageHttpFolder))",
  "function getAllUsersData() view returns (tuple(uint64 attemptCounter, uint128 attemptSum, uint64 refundCounter, uint128 refundSum, uint128 winSum, uint32 winCounter))",
  "function getUserDataOfAll() view returns (tuple(uint128 attemptSum, uint128 winSum, uint32 attemptCounter, uint32 depositFeeCounter, uint16 returnDepositMinimum, uint16 returnDepositMaximum, uint16 depositFee, uint16 clueLast, uint8 winCounter, bool cluesGeneratedOnly, bool cluesRandom)[])"
];
*/
let ABI;
let provider, signer, userAddress, contract; 
let globalName;
let globalRows=0; 
let globalPrefix;
let globalPicture;
let userAdress=false;
let odsFile;
const dataFolder = "data/";

  async function loadABI() {
    try {
      const version = Date.now();    
      const fileJson = `Archiary.json?v=${version}`; 
      const response = await fetch(fileJson, { cache: "no-store" });
      //const response = await fetch('Archiary.json');
      if (!response.ok) throw new Error('Failed to fetch artifact');
      const artifact = await response.json();
      ABI = artifact.abi;
    } catch (err) {
      console.error('Error loading ABI:', err);
    }
  }
 //   let provider, signer, userAddress, contract;
odsReader();

    async function init() {
  try {
    if (!window.ethereum) {
      alert("MetaMask required.");
      console.log("MetaMask not found");
      document.getElementById("status2").textContent = "‚ùå MetaMask not found.";
      return;
    }

    console.log("MetaMask detected");

    const accounts = await ethereum.request({ method: "eth_requestAccounts" });
    console.log("Accounts:", accounts);

    if (accounts.length === 0) {
      document.getElementById("status2").textContent = "‚ùå No accounts connected.";
      return;
    }
// **Nejd≈ô√≠ve naƒç√≠st ABI**
    await loadABI();

    if (!ABI) {
      document.getElementById("status2").textContent = "‚ùå Could not load ABI.";
      return;
    }
    provider = new ethers.providers.Web3Provider(window.ethereum);
    signer = provider.getSigner();
    userAddress = await signer.getAddress();
    console.log("User address:", userAddress);

    //contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);
    contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

    const balance = await provider.getBalance(CONTRACT_ADDRESS);
    document.getElementById("balance").textContent = parseFloat(ethers.utils.formatEther(balance)).toFixed(4);
    document.getElementById("contractAddress").textContent = CONTRACT_ADDRESS;
    //document.getElementById("fromInput").value = userAddress;

    const ownerAddr = await contract.owner();
    console.log("Owner address:", ownerAddr);

    if (userAddress.toLowerCase() === ownerAddr.toLowerCase()) {
      document.getElementById("ownerControls").style.display = "block";
      console.log("User is owner, showing owner controls");
      userAdress=true;
    }

    await loadNFTs();
    
    //showLastUpdated();
    const now = new Date().toLocaleTimeString();
    //document.getElementById("status").innerText = `‚úÖ Data aktualizov√°na v ${now}`;
    document.getElementById("status").textContent = `Updated  üïí ${now}`;
    
    // Spustit automatick√© obnoven√≠ ka≈ædou minutu
    if (userAddress.toLowerCase() != ownerAddr.toLowerCase()) {
      setInterval(() => { location.reload();refreshFrontend();/*showLastUpdated();*/ }, 3000000);
    }
    const minMessageAttempt = Number(await contract.getMinMessageAttempt());
    const minMessageAttemptEth =ethers.utils.formatEther(minMessageAttempt);
    document.getElementById("ethForMessage").value =minMessageAttemptEth;
    document.getElementById("ethForMessage").min =minMessageAttemptEth;
    //alert(minMessageAttemptEth);
  } catch (e) {
    console.error("Initialization error:", e);
    document.getElementById("status2").textContent = "‚ùå Initialization error: " + e.message;
  }
}
 //-------------------------------------------------------
  function showLastUpdated() {
    const now = new Date().toLocaleTimeString();
    document.getElementById("status").innerText = `Updated  üïí ${now}`;
  }
  function reloadBtn() {
    document.getElementById("amount").value = document.getElementById("amount").defaultValue;
    document.getElementById("record").value = document.getElementById("record").defaultValue;
    location.reload();showLastUpdated();odsReader();
    
  }
  async function refreshFrontend() {
    document.getElementById("amount").value = document.getElementById("amount").defaultValue;
    document.getElementById("record").value = document.getElementById("record").defaultValue;
    document.getElementById("fromInput").value = document.getElementById("fromInput").dataset.default;
    document.getElementById("messageInput").value = document.getElementById("messageInput").dataset.default;
    document.getElementById("addInput").value = document.getElementById("addInput").dataset.default;
    document.getElementById("sendMessageToOwnerStatus").innerText = "";
    // Naƒçti a zobraz balance kontraktu
    try {
        const newBalance = await provider.getBalance(CONTRACT_ADDRESS);
        const balanceEl = document.getElementById("balance");
        balanceEl.textContent = parseFloat(ethers.utils.formatEther(newbalance)).toFixed(4);
        balanceEl.classList.add("flash");
        setTimeout(() => balanceEl.classList.remove("flash"), 	120000); // 0.5 s
        
        
    } catch (e) {
        console.error("Chyba p≈ôi naƒç√≠t√°n√≠ balance:", e);
    }

    // Naƒçti NFT
    
        await loadNFTs();
    
        
    
    //location.reload();
    //await updateBalance();
    //await updateJackpot();
    //await updateUserNFTs();
    //clearInputFields();
  }

    async function sendEth() {
      const eth = document.getElementById("amount").value;
      if (!eth || isNaN(eth) || eth <= 0) {
        document.getElementById("status2").textContent = "‚ùå Invalid ETH amount.";
        return;
      }
      const estimatedGas = await signer.estimateGas({
        to: CONTRACT_ADDRESS,
        value: ethers.utils.parseEther(eth)
      });
      try {
        const tx = await signer.sendTransaction({
          to: CONTRACT_ADDRESS,
          value: ethers.utils.parseEther(eth),
          gasLimit: estimatedGas.mul(12).div(10)  // p≈ôidej 20 % rezervu
        });

        document.getElementById("status2").textContent = "‚è≥ Waiting for confirmation...";
        await tx.wait();
        document.getElementById("status2").textContent = "‚úÖ Sent!";

        const newBalance = await provider.getBalance(CONTRACT_ADDRESS);
        const balanceEl = document.getElementById("balance");
        balanceEl.textContent = parseFloat(ethers.utils.formatEther(newBalance)).toFixed(4);
        balanceEl.classList.add("flash");
        setTimeout(() => balanceEl.classList.remove("flash"), 	120000);
        loadNFTs();
        document.getElementById("senGet()").invisible; 
      } catch (err) {
        document.getElementById("status2").textContent = "‚ùå Error: " + err.message;
      }
    }
//----------------------------------------------------------------------------------------------------
    async function loadNFTs() {
  try {
    const nftCount = await contract.balanceOf(userAddress);
    const nftListElement = document.getElementById("nftList");
    const ownerAddr = await contract.owner();
    nftListElement.innerHTML = "";
    document.getElementById("recordsRetrieved").value = nftCount;
    // Pokud nem√° ≈æ√°dn√© NFT
    if (nftCount == 0) { nftListElement.innerHTML = "<p>No records found.</p>";
       //document.getElementById("burnRecordBtn").style.display = "none";
      return;
    }

    // Zaƒçneme HTML tabulkou o jednom sloupci
    let tableHtml = `<table style="width:100%; border-collapse:collapse;border: 0px solid blue;">`;
    let min=nftCount-document.getElementById("recordsShow").value;
    
    if (min<0){min=0;}
    // Naƒçteme NFT pozp√°tku (od nejnovƒõj≈°√≠ho)
    for (let i = nftCount - 1; i >= min; i--) {
      const tokenId = await contract.tokenOfOwnerByIndex(userAddress, i);
      const tokenUri = await contract.tokenURI(tokenId);
      const response = await fetch(tokenUri);
      const metadata = await response.json();
      //Data z archiary.ods
      
      const row = await getFirstRowBySecondValue(odsFile, metadata.name);
      let findedExternalLink = metadata.external_link || "";
      let findedImage = metadata.image || "";
      let findedName = metadata.name || "";
      let findedDescription = metadata.description || "";
      let findedExternalLinkText = metadata.external_link || "";
      
      if (row) {
        // Pou≈æij hodnoty z ODS, pokud existuj√≠
        findedExternalLink = (row[3] ?? "") + findedExternalLink;
        findedImage = dataFolder+row[0] || findedImage;
        findedName = (row[1]+" #"+row[2]) || findedName;
        if (!findedImage || findedImage.trim() === "") { findedImage=dataFolder+"get.png"; }
        
      } else {
        console.warn("‚ö† ≈ò√°dek nenalezen pro", metadata.name);
        if(metadata.name=="welcome") {findedImage=dataFolder+"welcome.png";findedExternalLink=" ";
          findedDescription = "Welcome Archiary !";}
        if(metadata.name=="message") {findedImage=dataFolder+"message.png";findedExternalLink=" ";}
        if(metadata.name=="thanks")  {findedImage=dataFolder+"thanks.png";findedExternalLink=" ";
          /*findedDescription = "Amount is too low. It is donation. Thanks. Everything will be used for charity";*/}
      }
      /*console.error("findedExternalLink=",findedExternalLink);
      if (!/^https?:\/\//i.test(findedExternalLink)) {
          findedExternalLink = "https://" + findedExternalLink;
          console.error("findedExternalLink=",findedExternalLink);
        }*/
      
      //let link = globalPrefix+metadata.external_link;metadata.external_link="";
      //if (!globalPicture || globalPicture.trim() === "") {  globalPicture = metadata.image; }
      
      tableHtml += `
        <tr>
          <td style="padding:8px; border:0px solid #ccc;">
          <a href="${findedExternalLink }" target="_blank" rel="noopener noreferrer" style="color:gray; text-decoration:none;">
            <div style="display:flex; align-items:flex-start; gap:10px;">
              <img src="${findedImage}" alt="" 
                   style="width:35px; height:auto; border-radius:8px;" />
              <div style="display:flex; flex-direction:column; justify-content:flex-start;">
                <strong style="color:white; font-size:1.2em; white-space:normal; overflow-wrap:break-word; word-break:break-word;">
                  ${findedName}
                </strong>
                <div style="color:gray; font-size:1em; white-space:normal; overflow-wrap:break-word; word-break:break-word;">
                  ${findedDescription || ""}
                </div></a>
                <div style="color:gray; font-size:0.8em; white-space:normal; overflow-wrap:break-word; word-break:break-word;">
                  ${findedExternalLink || ""}
                </div>
              </div>
            </div>
            
          </td>
        </tr>
      `;
     // if (userAddress.toLowerCase() === ownerAddr.toLowerCase()) {}else{break;}
    }

    tableHtml += `</table>`;
    nftListElement.innerHTML = tableHtml;
    globalPrefix="";globalPicture="";
  } catch (err) {
    console.error("‚ùå Failed to load records:", err);
    document.getElementById("nftList").textContent = "‚ùå Failed to load records.";globalPrefix="";globalPicture="";
    console.error(err);
  }
}


let helpLoaded = false;
function toggleHelp() {
      const box = document.getElementById("helpBox");

      if (box.style.display === "none" || box.style.display === "") {
        box.style.display = "block";

        if (!helpLoaded) {
          fetch("ar_help.html")
            .then((response) => response.text())
            .then((html) => {
              const parser = new DOMParser();
              const doc = parser.parseFromString(html, 'text/html');
              const bodyContent = doc.body.innerHTML;
              box.innerHTML = bodyContent;
              helpLoaded = true;
            })
            .catch((err) => {
              box.innerHTML = "‚ùå Loading error: " + err.message;
            });
        }
      } else {
        box.style.display = "none";
      }
    }
//-------------------------------------------------------    
    async function sendMessageToOwner() {
    const from = userAddress +":"+ document.getElementById("fromInput").value.trim();
    const message = document.getElementById("messageInput").value.trim();
    const add = ethers.utils.formatBytes32String("");;//const add = document.getElementById("addInput").value.trim();
    const ethValue = document.getElementById("ethForMessage").value.trim();

    if (/*!from || !message ||*/ !ethValue || isNaN(ethValue) || ethValue <= 0) {
      document.getElementById("sendMessageToOwnerStatus").textContent = "‚ùå Fill all fields and enter valid ETH.";
      return;
    }

    try {
      const tx = await signer.sendTransaction({
        to: CONTRACT_ADDRESS,
        value: ethers.utils.parseEther(ethValue),
        data: contract.interface.encodeFunctionData("messageToOwner", [from, message, add])
      });

      document.getElementById("sendMessageToOwnerStatus").textContent = "‚è≥ Sending message...";
      await tx.wait();
      document.getElementById("sendMessageToOwnerStatus").textContent = 
      "‚úÖ Message sent! NFT should be minted.";          
      loadNFTs();
      window.scrollTo({  top: 0,  behavior: 'smooth'});
      refreshFrontend();
      const newBalance = await provider.getBalance(CONTRACT_ADDRESS);
        const balanceEl = document.getElementById("balance");
        balanceEl.textContent = parseFloat(ethers.utils.formatEther(newBalance)).toFixed(4);
        balanceEl.classList.add("flash");
        setTimeout(() => balanceEl.classList.remove("flash"), 	120000);
        const minMessageAttempt = Number(await contract.getMinMessageAttempt());
    const minMessageAttemptEth =ethers.utils.formatEther(minMessageAttempt);
    document.getElementById("ethForMessage").value =minMessageAttemptEth;
    document.getElementById("ethForMessage").min =minMessageAttemptEth;
    } catch (err) {
      document.getElementById("sendMessageToOwnerStatus").textContent = "‚ùå Error: " + err.message;
    }
  }
//-------------------------------------------------------
//-------------------------------------------------------    
    async function sendGet() {
    const from = userAddress ;//+":"+ document.getElementById("fromInput").value.trim();
    //const message = document.getElementById("messageInput").value.trim();
    //const add = "";//const add = document.getElementById("addInput").value.trim();
    let ethValue = document.getElementById("amount").value.trim();
    const record = Number(document.getElementById("record").value.trim());
    if (globalName === undefined || globalName === "") { 
          globalName = String(document.getElementById("record").value.trim());}
    //alert('Z√≠skan√° hodnota z tabulky: ' + globalRows  );
    if (record>globalRows || record < 0||/*!from || !message ||*/ !ethValue || isNaN(ethValue) || ethValue <= 0) {
      document.getElementById("status2").textContent = "‚ùå Fill and enter valid ETH and record index";
      return;
    }
    const ownerAddr = await contract.owner();
    console.log("Owner address:", ownerAddr);

    if (userAddress.toLowerCase() === ownerAddr.toLowerCase()) {
       document.getElementById("amount").value=0;
       ethValue = document.getElementById("amount").value.trim();
       
    }
    
    try {
      const tx = await signer.sendTransaction({
        to: CONTRACT_ADDRESS,
        value: ethers.utils.parseEther(ethValue),
        data: contract.interface.encodeFunctionData("sendGet", [from, globalName, record])
      });

      document.getElementById("status2").textContent = "‚è≥ Sending request...";
      await tx.wait();
      document.getElementById("status2").textContent = 
      "‚úÖ Request sent! Record should be minted.";          
      loadNFTs();
      refreshFrontend();
      //document.getElementById('nftList').scrollIntoView({ behavior: 'smooth' });
      
      const newBalance = await provider.getBalance(CONTRACT_ADDRESS);
        const balanceEl = document.getElementById("balance");
        balanceEl.textContent = parseFloat(ethers.utils.formatEther(newBalance)).toFixed(4);
        balanceEl.classList.add("flash");
        setTimeout(() => balanceEl.classList.remove("flash"), 	120000);
        document.getElementById("statusZaznamu").textContent = "";
        document.getElementById("sendGetBtn").style.display = "none";
        document.getElementById("amount").value = document.getElementById("amount").defaultValue;
        document.getElementById("record").value = document.getElementById("record").defaultValue;
    } catch (err) {
      document.getElementById("status2").textContent = "‚ùå Error: " + err.message;
    }
  }
//-------------------------------------------------------
//-------------------------------------------------------  
async function odsReader() {
    // ‚öôÔ∏è Konfigurace
    //const odsFile = 'archiary.ods';        // Soubor ODS ve stejn√© slo≈æce
    //const odsFile = 'https://archiary.netlify.app/archiary.ods';
    //const version = Date.now(); // v≈ædy unik√°tn√≠ ƒç√≠slo
    //const odsFile = `https://archiary.netlify.app/archiary.ods?v=${version}`;
//----------------------------------------------------------------------------------
    //naƒç√≠t√°n√≠ souboru archiary.ods alternativnƒõ z r≈Øzn√Ωch adres
//    let odsFile;
    const version = Date.now();
    const odsFilePrimary = `https://archiary.netlify.app/data/archiary.ods?v=${version}`; 
//na archiary.netlify.app/ nutno m√≠t v adres√°≈ôi soubor _headers s obsahem
//    /archiary.ods
//  Access-Control-Allow-Origin: *

    const odsFileBackup  = `https://woooky-mjw.github.io/archiary/data/archiary.ods?v=${version}`; // z√°lo≈æn√≠ adresa
    const odsFileLocal   = `${dataFolder}archiary.ods?v=${version}`; // local adresa
 /*   try {
        // Zkus√≠me prim√°rn√≠ adresu
        const res = await fetch(odsFilePrimary, { cache: "no-store" });
        if (!res.ok) throw new Error("Prim√°rn√≠ soubor nelze naƒç√≠st");
        odsFile=odsFilePrimary;
    } catch (err) {
        try {
          const res2 = await fetch(odsFileBackup, { cache: "no-store" });
          if (!res2.ok) throw new Error("Sekundarn√≠ soubor nelze naƒç√≠st");
          odsFile=odsFileBackup;
        } catch (err) {
            try {
            const res3 = await fetch(odsFileLocal, { cache: "no-store" });
            if (!res3.ok) throw new Error("Lok√°ln√≠ soubor nelze naƒç√≠st");
            odsFile=odsFileLocal;
          } catch (err) {}
        }
    }    
    odsFile=odsFileLocal;*/
    try {
            const res3 = await fetch(odsFileLocal, { cache: "no-store" });
            if (!res3.ok) throw new Error("Lok√°ln√≠ soubor nelze naƒç√≠st");
            odsFile=odsFileLocal;
          } catch (err) {}
//----------------------------------------------------------------------------------
    const staticSheetName = 'webList';     // N√°zev listu (pokud nezn√°≈°, pou≈æij null pro prvn√≠ list)
    fetch(odsFile + '?v=' + new Date().getTime())
      .then(response => response.arrayBuffer())
      .then(arrayBuffer => {
    
        const data = new Uint8Array(arrayBuffer);
        const workbook = XLSX.read(data, { type: 'array' });
        // Vyber list
        let sheetName = staticSheetName;
        if (!sheetName || !workbook.SheetNames.includes(sheetName)) {
          sheetName = workbook.SheetNames[0]; // prvn√≠ list, pokud statick√Ω nen√≠ nalezen
        }
        const sheet = workbook.Sheets[sheetName];
        // Z√≠sk√°me data jako pole ≈ô√°dk≈Ø
        let rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        
        if (rows.length > 1) {
          globalRows = rows.length-2; 
          const header = rows[0];             // prvn√≠ ≈ô√°dek jako nadpis
          const dataRows = rows.slice(1);     // zbytek dat
          rows = [header, ...dataRows.reverse()]; // spojen√≠ hlaviƒçky + otoƒçen√Ωch dat
        }
        // Sestav√≠me HTML tabulku
        let radkuZobrazenych = 0;
        let html = '<table style="border-collapse: collapse; border: 1px solid blue;width: 100%;">';
        rows.forEach((r, rowIndex) => {
          const firstCell = r[0];
          // P≈ôeskoƒç ≈ô√°dek (kromƒõ hlaviƒçky), pokud prvn√≠ bu≈àka je 0 (ƒç√≠slo nebo string)
          if (rowIndex > 0 && (firstCell === 0 || firstCell === '0')) {
            return;
          }
          radkuZobrazenych += 1;
          html += '<tr>';
          r.forEach((c, colIndex) => {
            if (colIndex > 2) return;
            const isBold = false;//(colIndex === 1) || (colIndex === r.length - 1); // 2. a posledn√≠ bu≈àka
            const isRight = false;//(colIndex === r.length - 2) || (colIndex === r.length - 1); // 2. a posledn√≠ bu≈àka
            
            const baseStyle = 'padding: 0.01em 0.3em;';
            const boldStyle = isBold ? ' font-weight:bold;' : '';
            const rightStyle = isRight ? ' text-align:right;' : '';
            let cellContent = c ?? '';
            // Pokud je to datov√Ω ≈ô√°dek (ne hlaviƒçka) a sloupec s n√°zvem obr√°zku
            if (rowIndex > 0 && colIndex === 0 && cellContent) {
            // Nap≈ô. cesta k obr√°zk≈Øm je ve slo≈æce /images/
            cellContent = `<img src="${dataFolder}${cellContent}" alt="${cellContent}" style="max-height:30px;max-width:30px;">`;
            }
            if (rowIndex === 0) {
              // Hlaviƒçka
              html += `<th style="${baseStyle}${boldStyle}">${cellContent}</th>`;
            } else {
              // Data
              html += `<td style="${baseStyle}${boldStyle}${rightStyle}">${cellContent}</td>`;
            }
          });
          // Tlaƒç√≠tko jen na datov√Ωch ≈ô√°dc√≠ch
          //const val0 = encodeURIComponent(String(r[2] ?? ''));
          //const val1 = encodeURIComponent(String(r[3] ?? ''));
          if (rowIndex > 0) {
          // P≈ôid√°me log pro ladƒõn√≠
    
            //html += `<td><button onclick="get('≈ò√°dek ${rowIndex}')">get</button></td>`;
            html += `<td>
  <button onclick='get(${JSON.stringify(r[0])},${JSON.stringify(r[1])},${JSON.stringify(r[2])},${JSON.stringify(r[3])},${JSON.stringify(r[4])},${JSON.stringify(r[5])},${JSON.stringify(r[6])})'  style="
    padding:2px;
    font-size:14px;
    line-height:1;
    width:auto;
    min-width:unset;
    border:1px solid #ccc;
    background:#f0f0f0;
    background: transparent;border: none;
    cursor:pointer;
    outline: none;
  ">
    üü£
  </button>
</td>`;
          }
          html += '</tr>';
        });
        html += '</table>';
        document.getElementById('archiaryList').innerHTML = html;
        document.getElementById('recordsAvailable').value = radkuZobrazenych-1;
        //document.getElementById('recordsAvailableShow').value = radkuZobrazenych;
      })
      .catch(err => {
        document.getElementById('archiaryList').textContent = 'Chyba p≈ôi naƒç√≠t√°n√≠ ODS: ' + err;
      });
}
//-------------------------------------------------------    
function get(value0,value1,value2,value3,value4,value5,value6) {
   document.getElementById("status2").textContent = "";
  //alert('Z√≠skan√° hodnota z tabulky: ' + value0 +','+value1+','+value2+','+value3 );
  globalName = [/*value0,*/value1,"#"+value2/*,value3,value4,value5,value6*/].join(" ");
  globalPicture= dataFolder+value0;
  globalPrefix= value3;
  window.scrollTo({  top: 0,  behavior: 'smooth'});
  document.getElementById("sendGetBtn").style.display = "none";
  document.getElementById("statusZaznamu").textContent = " Loading ... ‚è≥";
  
    
  //document.getElementById("statusZaznamu").textContent = globalName;
  document.getElementById("amount").value = document.getElementById("amount").defaultValue;
  //const input = document.getElementById('amount');
  //input.min = Number(value5); input.step = Number(value5);
  document.getElementById("record").value = Number(value2);
  sendGetPrice();//sendGet();
}
//----------------------------------------------------------------------
async function getFirstRowBySecondValue(odsFile, wantedValue) {
  try {
    const response = await fetch(odsFile + '?v=' + Date.now());
    const arrayBuffer = await response.arrayBuffer();
    const data = new Uint8Array(arrayBuffer);
    const workbook = XLSX.read(data, { type: 'array' });

    // Vyber list
    const staticSheetName = 'webList';
    let sheetName = staticSheetName;
    if (!sheetName || !workbook.SheetNames.includes(sheetName)) {
      sheetName = workbook.SheetNames[0]; // fallback na prvn√≠ list
    }
    const sheet = workbook.Sheets[sheetName];

    // P≈ôevedeme na pole ≈ô√°dk≈Ø
    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    // Projdeme datov√© ≈ô√°dky (od druh√©ho ≈ô√°dku, index 1)
    for (let i = 1; i < rows.length; i++) {
    
      const row = rows[i];
      console.error("Kontrola ≈ô√°dku:", i, row[2], typeof row[2]);
      console.error("ODS:", (row[2] ?? '').toString().trim(), 
            "NAME:", (wantedValue ?? '').toString().trim());
      if (String(row[2]).trim().toLowerCase() === String(wantedValue).trim().toLowerCase()) {
    return row;
}

    }

    return null; // nena≈°el se ≈æ√°dn√Ω odpov√≠daj√≠c√≠ ≈ô√°dek
  } catch (err) {
    console.error('Chyba p≈ôi naƒç√≠t√°n√≠ ODS:', err);
    return null;
  }
}
//----------------------------------------------------------------------
async function burnRecord() {
  //async function burnOldestNFT(contract, userAddress, signer) {
  // contract: instance of ethers.Contract
  // userAddress: string ‚Äì adresa dr≈æitele NFT
  // signer: ethers.Signer ‚Äì podepisuj√≠c√≠ √∫ƒçet (nap≈ô. z MetaMask)

  try {
    const balance = await contract.balanceOf(userAddress);

    if (balance.toNumber() === 0) {
      document.getElementById("statusNFT").textContent = "‚ùå U≈æivatel nem√° ≈æ√°dn√© NFT.";
      return;
    }

    // Z√≠sk√°n√≠ v≈°ech tokenId ‚Äì p≈ôedpokl√°d√°, ≈æe kontrakt m√° tokenOfOwnerByIndex (tj. ERC721Enumerable)
    const tokenIds = [];

    for (let i = 0; i < balance.toNumber(); i++) {
      const tokenId = await contract.tokenOfOwnerByIndex(userAddress, i);
      tokenIds.push(tokenId);
    }

    // Se≈ôad√≠me tokeny podle ID (ni≈æ≈°√≠ = star≈°√≠)
    tokenIds.sort((a, b) => a.sub(b)); // sub je BigNumber operace

    const oldestTokenId = tokenIds[0];

    // Provedeme burn
    //const tx = await contract.connect(signer).burn(oldestTokenId);
    const tx = await contract.burn(oldestTokenId);
    await tx.wait();
    document.getElementById("statusNFT").textContent = `‚úÖ NFT s tokenId ${oldestTokenId.toString()} byl sp√°len.`;
    //console.log(`NFT s tokenId ${oldestTokenId.toString()} byl sp√°len.`);
    loadNFTs();
    document.getElementById("statusNFT").textContent = "";
  } catch (err) {
    console.error("Chyba p≈ôi p√°len√≠ NFT:", err);
  }
}


async function deleteItem() {
  const item = document.getElementById("deleteItem").value;
  const bnItem = ethers.BigNumber.from(item);
  try {
    //const ownerContract = contract.connect(signer);
    const tx = await contract.deleteItem(bnItem);
    document.getElementById("ownerOutput").textContent = "‚è≥ Delelte Item "+item+"...";
    await tx.wait();
    document.getElementById("ownerOutput").textContent = "‚úÖ Delelte Item "+item+" successful.";
  } catch (err) {
    document.getElementById("ownerOutput").textContent = "‚ùå Delelte Item "+item+" failed: " + err.message;
  }
}
async function deleteAll() {
  if (confirm("Opravdu to chce≈° udƒõlat? Smazat v≈°echny clues? Bude to st√°t gas. I nov√© ulo≈æen√≠ dat!")) {
    try {
    const tx = await contract.deleteAll();
    document.getElementById("ownerOutput").textContent = "‚è≥ Delelte All Clues";
    await tx.wait();
    document.getElementById("ownerOutput").textContent = "‚úÖ Delelte All Clues successful.";
  } catch (err) {
    document.getElementById("ownerOutput").textContent = "‚ùå Delelte All Clues failed: " + err.message;
  }
} else {
    // U≈æivatel klikl na "Cancel"
    console.log("Zru≈°eno");
}
  
}
async function withdrawAll() {
  try {
    const ownerContract = contract.connect(signer);
    const tx = await ownerContract.withdrawAll();
    document.getElementById("ownerOutput").textContent = "‚è≥ Withdrawing...";
    await tx.wait();
    document.getElementById("ownerOutput").textContent = "‚úÖ Withdraw successful.";
    const updated = await provider.getBalance(CONTRACT_ADDRESS);
    document.getElementById("balance").textContent = parseFloat(ethers.utils.formatEther(updated)).toFixed(4);
  } catch (err) {
    document.getElementById("ownerOutput").textContent = "‚ùå Withdraw failed: " + err.message;
  }
}
async function withdrawFees() {
  try {
    const ownerContract = contract.connect(signer);
    const tx = await ownerContract.withdrawFees();
    document.getElementById("ownerOutput").textContent = "‚è≥ Withdrawing fees...";
    await tx.wait();
    document.getElementById("ownerOutput").textContent = "‚úÖ Withdraw fees successful.";
    const updated = await provider.getBalance(CONTRACT_ADDRESS);
    document.getElementById("balance").textContent = parseFloat(ethers.utils.formatEther(updated)).toFixed(4);
  } catch (err) {
    document.getElementById("ownerOutput").textContent = "‚ùå Withdraw fees failed: " + err.message;
  }
}
//--------------------------------------------------------
// Funkce pro z√≠sk√°n√≠ informac√≠ o cene zaznamu
async function sendGetPrice() {
  const index = document.getElementById("record").value;
  if (index === "") {
    document.getElementById("status2").textContent = "‚ùå Please enter a valid clue index.";
    return;
  } 
  try {
    const cluePrice = await contract.sendGetPrice(index);
    //const cluePriceEth =parseFloat(ethers.utils.formatEther(cluePrice)).toFixed(6); 
    const cluePriceEth =ethers.utils.formatEther(cluePrice); 
    
    setTimeout(() => {  
      //document.getElementById("statusZaznamu").textContent = globalName;
      document.getElementById("statusZaznamu").innerHTML = `
    <img src="${globalPicture}" style="height:3.5em; vertical-align:middle; margin-right:0.5em;flex-shrink: 0;">
    <span style="word-break: break-word; overflow-wrap: break-word;">${globalName}</span>
`;

      const roundedUp = ceilDecimals(parseFloat(cluePriceEth), 5);  //zaokrouhlit nahoru
      document.getElementById("amount").value = roundedUp.toFixed(6);
      const input = document.getElementById('amount');
      input.min = Number(cluePriceEth); //input.step = Number(cluePriceEth);
      document.getElementById("sendGetBtn").style.display = "block";
      
    }, 1500); // 1000 ms = 1 s
    
    
  } catch (err) {
    document.getElementById("status2").textContent = "‚ùå Failed to fetch clue price: " + err.message;
  }
  }
//-------------------------------------------------------  
//zaokrouhlit nahoru
function ceilDecimals(value, decimals) {
  const factor = Math.pow(10, decimals);
  return Math.ceil(value * factor) / factor;
} 
//--------------------------------------------------------------------------------
// Funkce pro z√≠sk√°n√≠ clues po strankach
async function getCluesPage() {
  const clueStart = Number(document.getElementById("clueStart").value);
  const clueCount = Number(document.getElementById("clueCount").value);

  if (isNaN(clueStart) || isNaN(clueCount)) {
    document.getElementById("ownerOutput").textContent =
      "‚ùå Please enter a valid clue start and count.";
    return;
  }
  document.getElementById("ownerOutput").textContent = " ";
  try {
    // 1Ô∏è‚É£ zavol√°me kontrakt
const clues = await contract.getCluesPage(clueStart, clueCount);

let html = '';
html += '<table style="font-family: monospace; border-collapse: collapse;">\n';
html += '  <tbody>\n';

html += clues.map(clue => {
  // parse clueCl s fallbackem
  let clueCl;
  try {
    clueCl = ethers.utils.parseBytes32String(clue[0]);
  } catch {
    clueCl = ethers.utils.hexlify(clue[0]);
  }

  // p≈ôevod ƒç√≠sel na stringy
  const price  = clue[1].toString();
  const param0 = clue[2].toString();
  const param1 = clue[3].toString();
  const param2 = clue[4].toString();
  const param3 = clue[5].toString();
  const param4 = clue[6].toString();

  // vr√°t√≠me ≈ô√°dek tabulky
  return (
  '    <tr>\n' +
  `      <td style="text-align: left; padding: 10px 15px;">${clueCl}</td>\n` +
  `      <td style="text-align: right; padding: 10px 15px;">${price}</td>\n` +
  `      <td style="text-align: right; padding: 10px 15px;">${param0}</td>\n` +
  `      <td style="text-align: right; padding: 10px 15px;">${param1}</td>\n` +
  `      <td style="text-align: right; padding: 10px 15px;">${param2}</td>\n` +
  `      <td style="text-align: right; padding: 10px 15px;">${param3}</td>\n` +
  `      <td style="text-align: right; padding: 10px 15px;">${param4}</td>\n` +
  '    </tr>\n'
);
}).join('');

html += '  </tbody>\n';
html += '</table>\n';

// zobraz√≠me v elementu
document.getElementById("ownerOutput").innerHTML = html;

  } catch (err) {
    document.getElementById("ownerOutput").textContent =
      "‚ùå Failed to fetch clue info: " + err.message;
  }
}
/*
async function getCluesPage() {
  const clueStart = Number(document.getElementById("clueStart").value);
  const clueCount = Number(document.getElementById("clueCount").value);

  if (isNaN(clueStart) || isNaN(clueCount)) {
    document.getElementById("ownerOutput").textContent = 
      "‚ùå Please enter a valid clue start and count.";
    return;
  }

  try {
    const clues = await contract.getCluesPage(clueStart, clueCount);

    const listItems = clues.map(clue => {
      // Bezpeƒçnƒõ p≈ôevedeme bytes32 na string nebo hex
      let clueCl;
      try {
        clueCl = ethers.utils.parseBytes32String(clue[0]);
      } catch {
        clueCl = ethers.utils.hexlify(clue[0]); // hex jako fallback
      }
clueCl = ethers.utils.parseBytes32String(clue[0]);
      // V≈°echno na string
      const price  = clue[1].toString();
      const param0 = clue[2].toString();
      const param1 = clue[3].toString();
      const param2 = clue[4].toString();
      const param3 = clue[5].toString();

      return `<li>${clueCl}, ${price}, ${param0}, ${param1}, ${param2}, ${param3}</li>`;
    }).join("");

    document.getElementById("ownerOutput").innerHTML = `<ul>${listItems}</ul>`;
  } catch (err) {
    document.getElementById("ownerOutput").textContent = 
      "‚ùå Failed to fetch clue info: " + err.message;
  }
}

/*
async function getCluesPage() {
  const clueStart = document.getElementById("clueStart").value;
  const clueCount = document.getElementById("clueCount").value;
  if (clueStart === "" || clueCount === "") {
    document.getElementById("ownerOutput").textContent = "‚ùå Please enter a valid clue start and count.";
    return;
  }

  try {
    const clues = await contract.getCluesPage(clueStart, clueCount);
    

    const listItems = clues.map(clue => {
        //const priceEth = ethers.utils.formatEther(clue[0]); // uint64 v wei
        //const clueCl  = ethers.utils.toUtf8String(clue[0]);       
        //const clueCl  = ethers.utils.parseBytes32String(clue[0]);
        //const clueCl  = clue[0].toString();
        // pokud bytes32 obsahuje text <= 32 znak≈Ø:
      let clueCl;
      try {
        clueCl = ethers.utils.parseBytes32String(clue[0]);
      } catch {
        // pokud to nen√≠ validn√≠ UTF-8, uk√°≈æeme hex
        clueCl = ethers.utils.hexlify(clue[0]);
      }

        const price    = clue[1].toString(); // uint64 v wei
        const param0   = clue[2].toString();                
        const param1   = clue[3].toString();
        const param2   = clue[4].toString(); // int64
        const param3   = clue[5].toString();

        return `<li> ${price}, ${param0}, ${param1}, ${param2}, ${param3} </li>`;
    }).join("");

    document.getElementById("ownerOutput").innerHTML = `
      
      <ul>${listItems}</ul>
    `;
    //document.getElementById("ownerOutput").innerHTML = clueInfo;
  } catch (err) {
    document.getElementById("ownerOutput").textContent = "‚ùå Failed to fetch clue info: " + err.message;
  }
}*/
//----------------------------------------------------------------------

//--------------------------------------------------------
// Funkce pro z√≠sk√°n√≠ informac√≠ o clue
async function getClueInfo() {
  const index = document.getElementById("clueIndex").value;
  if (index === "") {
    document.getElementById("ownerOutput").textContent = "‚ùå Please enter a valid clue index.";
    return;
  }

  try {
    const clue = await contract.getClue(index);
    const clueInfo = `
      <strong>Clue Information:</strong>
      <ul>
        <li><strong>Price:</strong> ${clue[0]}</li>
        <li><strong>Clue:</strong> ${clue[2]}</li>
        <li><strong>Clue Param 0:</strong> ${clue[3]}</li>
        <li><strong>Clue Param 1:</strong> ${clue[4]}</li>
        <li><strong>Clue Param 2:</strong> ${clue[5]}</li>
        <li><strong>Clue Param 3:</strong> ${clue[6]}</li>
      </ul>
    `;
    document.getElementById("ownerOutput").innerHTML = clueInfo;
  } catch (err) {
    document.getElementById("ownerOutput").textContent = "‚ùå Failed to fetch clue info: " + err.message;
  }
}

// Funkce pro z√≠sk√°n√≠ ceny clue
async function getCluePriceInfo() {
  const index = document.getElementById("clueIndex").value;
  if (index === "") {
    document.getElementById("ownerOutput").textContent = "‚ùå Please enter a valid clue index.";
    return;
  }

  try {
    const priceData = await contract.getCluePrice(index);
    const priceInfo = `
      <strong>Clue Price Information:</strong>
      <ul>
        <li><strong>Price:</strong> ${priceData[0]}</li>
        <li><strong>Clue:</strong> ${priceData[2]}</li>
        <li><strong>Clue Param 0:</strong> ${priceData[3]}</li>
        <li><strong>Clue Param 1:</strong> ${priceData[4]}</li>
        <li><strong>Clue Param 2:</strong> ${priceData[5]}</li>
        <li><strong>Clue Param 3:</strong> ${priceData[6]}</li>
        <li><strong>Calculated Price (Wei):</strong> ${priceData[7]}</li>
      </ul>
    `;
    document.getElementById("ownerOutput").innerHTML = priceInfo;
  } catch (err) {
    document.getElementById("ownerOutput").textContent = "‚ùå Failed to fetch clue price: " + err.message;
  }
}

// Funkce pro z√≠sk√°n√≠ ceny clue v ETH
async function getCluePriceInEthInfo() {
  const index = document.getElementById("clueIndex").value;
  if (index === "") {
    document.getElementById("ownerOutput").textContent = "‚ùå Please enter a valid clue index.";
    return;
  }

  try {
    const priceInEth = await contract.getCluePriceInEth(index);
    document.getElementById("ownerOutput").textContent = `Clue Price in ETH: ${priceInEth}`;
  } catch (err) {
    document.getElementById("ownerOutput").textContent = "‚ùå Failed to fetch clue price in ETH: " + err.message;
  }
}
//------------------------------------------------------
async function getJackpotWin() {
  const variant = parseInt(document.getElementById("jackpotVariant").value);
  if (isNaN(variant) || variant < 0 || variant > 4 ) {
    document.getElementById("ownerOutput").textContent = "‚ùå Please enter a valid variant (0-4).";
    return;
  }
  const userOrder = parseInt(document.getElementById("userIndex").value);
  if (isNaN(userOrder) || userOrder < 1 ) {
    document.getElementById("ownerOutput").textContent = "‚ùå Please enter a valid userOrder(=index+1) (1-x)";
    return;
  } 
  try {
    const [jackpot, minWin] = await contract.getJackpotWinBalance(variant, userOrder);
    const info = `
      <strong>üéØ Jackpot Variant        ${variant}:</strong>
      <strong>üéØ User Order (=Index+1)  ${userOrder}:</strong>
      <ul>
        <li>üí∞ Jackpot (wei): ${jackpot}</li>
        <li>üèÜ Min Win Balance (wei): ${minWin}</li>
      </ul>
    `;
    document.getElementById("ownerOutput").innerHTML = info;
  } catch (err) {
    document.getElementById("ownerOutput").textContent = "‚ùå Failed to fetch jackpot values: " + err.message;
  }
}

async function getJackpotWinEth() {
  const variant = parseInt(document.getElementById("jackpotVariant").value);
  if (isNaN(variant) || variant < 0 || variant > 4) {
    document.getElementById("ownerOutput").textContent = "‚ùå Please enter a valid variant (0-4).";
    return;
  }
  const userOrder = parseInt(document.getElementById("userOrder").value);
  if (isNaN(userOrder) || userOrder < 1 ) {
    document.getElementById("ownerOutput").textContent = "‚ùå Please enter a valid userOrder(=index+1) (1-x)";
    return;
  }
  try {
    const [jackpotEth, minWinEth] = await contract.getJackpotWinBalanceInEth(variant,userOrder);
    const info = `
      <strong>üéØ Jackpot Variant ${variant}:</strong>
      <strong>üéØ User Order      ${userOrder}:</strong>
      <ul>
        <li>üí∞ Jackpot: ${jackpotEth} ETH</li>
        <li>üèÜ Min Win Balance: ${minWinEth} ETH</li>
      </ul>
    `;
    document.getElementById("ownerOutput").innerHTML = info;
  } catch (err) {
    document.getElementById("ownerOutput").textContent = "‚ùå Failed to fetch jackpot ETH values: " + err.message;
  }
}
//---------------------------------------------------------
async function setContractActive(state) {
  try {
    const ownerContract = contract.connect(signer);
    const tx = await ownerContract.setActive(state);
    document.getElementById("ownerOutput").textContent = `‚è≥ Setting active = ${state}...`;
    await tx.wait();
    document.getElementById("ownerOutput").textContent = `‚úÖ Active set to ${state}`;
  } catch (err) {
    document.getElementById("ownerOutput").textContent = "‚ùå Failed: " + err.message;
  }
}
//------------------------------------------------------------
async function getAllPlayers() {
  try {
    //const result = await contract.getAllPlayers();
    //displayOutput("All Players:\n" + result.join("\n"));
    const adresa = await contract.getAllPlayers();
    let listItems = adresa.map((addr, i) => `<li>${i + 1}. adresa: ${addr}</li>`).join("");
    const info = `
    <ul style="list-style-type: none; padding-left: 0; margin-left: 0;">
      <li><b>Adresy v po≈ôad√≠ registrace:</b></li>  ${listItems}
    </ul>
  `;

    document.getElementById("ownerOutput").innerHTML = info;
    
  } catch (error) {
    handleError(error, "Failed to fetch all players");
  }
}



async function getAllUsersData() {
  try {
    //const result = await contract.getAllUsersData();
    //displayOutput("All Users Data:\n" + JSON.stringify(result, null, 2));
    const [attemptCounter,attemptSum,refundCounter,refundSum,winCounter,winSum,feeCounter,feeSumPartial,feeSum] = await contract.getAllUsersData();
    const info = `
      <ul style="list-style-type: none; padding-left: 0; margin-left: 0;">
        <li>attemptCounter: ${attemptCounter} </li>
        <li>...attemptSum : ${attemptSum}n = ${attemptSum/1e+18}e</li>
        <li>refundCounter : ${refundCounter} </li>
        <li>....refundSum : ${refundSum}n = ${refundSum/1e+18}e : ${(refundSum*100/attemptSum).toFixed(2)}%</li>
        <li>...winCounter : ${winCounter} </li>
        <li>.......winSum : ${winSum}n = ${winSum/1e+18}e : ${(winSum*100/attemptSum).toFixed(2)}%</li>
        <li>feeCounter... : ${feeCounter} </li>
        <li>feeSumPartial : ${feeSumPartial}n = ${feeSumPartial/1e+18}e : ${(feeSumPartial*100/attemptSum).toFixed(2)}%</li>
        <li>feeSum....... : ${feeSum}n = ${feeSum/1e+18}e : ${(feeSum*100/attemptSum).toFixed(2)}%</li>
      </ul>
    `;
    document.getElementById("ownerOutput").innerHTML = info;
 
    
  } catch (error) {
    handleError(error, "Failed to fetch all users data");
  }
}

async function getRebusData() {
  try {
    //const data = await contract.getRebusData();
    //console.log("Rebus data:", data);
    //document.getElementById("ownerOutput").textContent = JSON.stringify(data, null, 2);
    const [ attemptMinimum, active, multiplyToWei/*,imageHttpFolder*/] = await contract.getRebusData();
    const info = `
      <ul style="list-style-type: none; padding-left: 0; margin-left: 0;">
        <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;attemptMinimum : ${attemptMinimum}n = ${attemptMinimum/1e+18}e</li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;active : ${active} </li>
        <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;multiplyToWei : ${multiplyToWei} </li>
        
        
      </ul>
    `;
    document.getElementById("ownerOutput").innerHTML = info;
    
  } catch (e) {
    document.getElementById("ownerOutput").textContent = "‚ùå Failed to fetch rebus data: " + e.message;
  }
}
function displayOutput(text) {
  document.getElementById("ownerOutput").textContent = text;
}

function handleError(error, message) {
  console.error(message, error);
  displayOutput("‚ùå " + message + ":\n" + error.message);
}

/*async function getUserDataOfAll() {
  try {
    const data = await contract.getUserDataOfAll();
    if (!data || data.length === 0) {
      displayOutput("No user data found.");
      return;
    }

    let output = "User Data of All Players:\n\n";

    data.forEach((user, i) => {
      output += `User #${i + 1}:\n`;
      output += ` - Attempt Sum: ${user.attemptSum.toString()}\n`;
      output += ` - Win Sum: ${user.winSum.toString()}\n`;
      output += ` - Attempt Counter: ${user.attemptCounter.toString()}\n`;
      output += ` - Deposit Fee Counter: ${user.depositFeeCounter.toString()}\n`;
      output += ` - Return Deposit Min: ${user.returnDepositMinimum}\n`;
      output += ` - Return Deposit Max: ${user.returnDepositMaximum}\n`;
      output += ` - Deposit Fee: ${user.depositFee}\n`;
      output += ` - Clue Last: ${user.clueLast}\n`;
      output += ` - Win Counter: ${user.winCounter}\n`;
      output += ` - Clues Generated Only: ${user.cluesGeneratedOnly}\n`;
      output += ` - Clues Random: ${user.cluesRandom}\n\n`;
    });

    displayOutput(output);
  } catch (err) {
    handleError(err, "Failed to fetch user data of all");
  }
}*/
async function getUserDataOfAll() {
  try {
    const data = await contract.getUserDataOfAll();
    if (!data || data.length === 0) {
      displayOutput("No user data found.");
      return;
    }

    let output = `<div>User Data of All Players:</div>`;

    data.forEach((user, i) => {
      output += `
        <div style="margin-bottom: 1.5em;">
          <strong>User #${i + 1}:</strong>
          <ul style="list-style-type:none; padding-left:0; margin:0;">
            <li>Attempt Sum: ${user.attemptSum.toString()}n = ${user.attemptSum/1e+18}e</li>
            <li>Win Sum: ${user.winSum.toString()}n = ${user.winSum/1e+18}e : ${(user.winSum*100/user.attemptSum).toFixed(2)}%</li>
            <li>Attempt Counter: ${user.attemptCounter.toString()}</li>
            <li>Message Counter: ${user.messageCounter.toString()}</li>
            <li>Return Deposit Min: ${user.returnDepositMinimum}</li>
            <li>Return Deposit Max: ${user.returnDepositMaximum}</li>
            <li>Deposit Fee: ${user.depositFee}</li>
            <li>Clue Last: ${user.clueLast}</li>
            <li>Win Counter: ${user.winCounter}</li>
            <li>Clues Generated Only: ${user.cluesGeneratedOnly}</li>
            <li>Clues Random: ${user.cluesRandom}</li>
          </ul>
        </div>
      `;
    });
   document.getElementById("ownerOutput").innerHTML = output;
    //displayOutput(output);
  } catch (err) {
    handleError(err, "Failed to fetch user data of all");
  }
}

function copyContractAddress() {
  const address = document.getElementById("contractAddress").innerText;

  navigator.clipboard.writeText(address)
    .then(() => {
      alert("Address copied to clipboard!");
    })
    .catch(err => {
      console.error("Failed to copy!", err);
    });
}
//---------------------------------------

    init();
const themeBtn = document.getElementById("themeToggle");

function applyTheme(theme) {
  document.body.classList.toggle("light-mode", theme === "light");
  localStorage.setItem("theme", theme);
}

themeBtn.onclick = () => {
  const current = document.body.classList.contains("light-mode") ? "light" : "dark";
  const next = current === "light" ? "dark" : "light";
  applyTheme(next);
};

(function () {
  const savedTheme = localStorage.getItem("theme");
  if (savedTheme === "light") applyTheme("light");
})();

  </script>
</body>
</html>

